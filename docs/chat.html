<!DOCTYPE html>

<html>
<head>
  <title>The Client</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>The Client</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="string">'emoticons'</span>, <span class="string">'timer'</span>, <span class="string">'types'</span>, <span class="string">'socket.io'</span>], <span class="keyword">function</span>(emoticons, Timer, types) {

    console.log(types);
    console.log(types.NORMAL);

    <span class="keyword">var</span> socket = io.connect(<span class="string">'http://'</span> + document.location.host),

        writingUsers = [],
        timers = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h3>References to DOM elements</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>        field =      document.querySelector(<span class="string">'.field'</span>),
        sendButton = document.querySelector(<span class="string">'.send'</span>),
        content =    document.querySelector(<span class="string">'.messages'</span>),
        notice =     document.querySelector(<span class="string">'.notice'</span>),

        cmdRegex = <span class="regexp">/^\/([a-z0-9_-]+)\s?([a-z0-9_-]+)?\s?([a-z0-9_-]+)?$/i</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2>Functions</h2>
<h3>Getters and Setters</h3>
<p>getters return <code>null</code> if the value hasn&#39;t been set first.</p>
<p>setters return <code>true</code> on success, <code>false</code> otherwise.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getNick = <span class="keyword">function</span>() {
            <span class="keyword">return</span> localStorage.getItem(<span class="string">'name'</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>saves nickname in localStorage.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setNick = <span class="keyword">function</span>(nick) {
            <span class="keyword">if</span> (nick) {
                localStorage.setItem(<span class="string">'name'</span>, nick);
                <span class="keyword">return</span> <span class="literal">true</span>;
            }
            <span class="keyword">return</span> <span class="literal">false</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>gets the Socket ID.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getId = <span class="keyword">function</span>() {
            <span class="keyword">return</span> localStorage.getItem(<span class="string">'id'</span>);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>sets the Socket ID.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setId = <span class="keyword">function</span>(id) {
            <span class="keyword">if</span> (id) {
                localStorage.setItem(<span class="string">'id'</span>, id);
                <span class="keyword">return</span> <span class="literal">true</span>;
            }
            <span class="keyword">return</span> <span class="literal">false</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3>Utility functions</h3>
<p>generates a random nickname:
useful when an unknown user connects for the first time.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        generateNick = <span class="keyword">function</span>() {
            <span class="keyword">var</span> _maxRandomInt = <span class="number">99999</span>,
                randomInt = Math.floor(Math.random()*_maxRandomInt+<span class="number">1</span>),
                randomName = <span class="string">'Guest'</span> + randomInt;
            <span class="keyword">return</span> randomName;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>creates a new message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        message = <span class="keyword">function</span>(options) {

            <span class="keyword">var</span> id   = options.id   || getId(),
                name = options.name || getNick(),
                text = options.text || field.value.trim(),
                type = options.type || types.NORMAL,
                time = options.time || (<span class="keyword">new</span> Date()).getTime();

            <span class="keyword">return</span> {
                id:   id,
                name: name,
                text: text,
                type: type,
                time: time
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>eats a message object, and returns the same object
with the text&#39;s placeholders replaced with images.
The images actually are just plain HTML.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        searchAndReplaceEmoticonsIn = <span class="keyword">function</span>(message) {

            <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;emoticons.skype.length; i++) {

                <span class="keyword">var</span> search, replacement;
                <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> emoticons.skype[i]) {
                    search = k,
                    replacement = emoticons.skype[i][k];
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>the <code>search</code> emoticon is contained in <code>message</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (message.text.indexOf(search) != -<span class="number">1</span>) {
                    <span class="keyword">var</span> htmlReplacement = <span class="string">'&lt;img src="img/skype/'</span> + replacement +
                     <span class="string">'" alt="'</span> + search + <span class="string">'" /&gt;'</span>;
                    message.text = message.text.replace(search, htmlReplacement);
                }                    
            }
            <span class="keyword">return</span> message;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>is it a command?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        isCommand = <span class="keyword">function</span>(text) {
            <span class="keyword">return</span> cmdRegex.test(text);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>gets command name and arguments from the provided text,
assuming that the text is an actual command.
You should call isCommand() before this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        getCommandFrom = <span class="keyword">function</span>(text) {
            <span class="keyword">var</span> matches = cmdRegex.exec(text),
                name = matches[<span class="number">1</span>],
                args = [
                    matches[<span class="number">2</span>], 
                    matches[<span class="number">3</span>]
                ];

            <span class="keyword">return</span> {
                name: name,
                args: args
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>evaluates a command. 
the first parameter is the command name, while
the second is an array containing the arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        evaluate = <span class="keyword">function</span>(command, args) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap for-h4">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h4>Commands</h4>
<h5>Nick</h5>
<p>sets the nickname.
Usage: <code>/nick &lt;nickname&gt;</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="regexp">/nick/i</span>.test(command)) {

                <span class="keyword">var</span> name = args[<span class="number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>here we just make sure the user has specified the new name.
name is certainly valid because the command regex has
already validated it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (name) {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>notify the server</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    socket.emit(<span class="string">'set nickname'</span>, {
                        oldName: getNick(), 
                        newName: name
                    });</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>update nickname locally</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    setNick(name);

                    <span class="keyword">return</span> <span class="literal">true</span>;
                }
                <span class="keyword">return</span> <span class="literal">false</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap for-h5">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h5>Foo</h5>
<p>just a test command.
Usage: <code>/foo [arg1] [arg2]</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="regexp">/foo/i</span>.test(command)) {
                alert(args[<span class="number">0</span>]);
                <span class="keyword">return</span> <span class="literal">true</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>not a valid command...</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            printMessage({
                name: <span class="string">'Server'</span>,
                text: command + <span class="string">' is not a valid command.'</span>,
                type: <span class="number">0</span>,
                time: (<span class="keyword">new</span> Date()).getTime()
            });
            maybeScrollToBottom();

            <span class="keyword">return</span> <span class="literal">false</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>reads the field.value. if it&#39;s empty, it just does nothing.
checks whether the field.value is a command. If so, it executes it.
else it just searches for emoticons and finally it notifies the server
that the user wants to send the message.
it also clears the field.value (input tag).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        send = <span class="keyword">function</span>(data) {

            <span class="keyword">if</span> (data.text == <span class="string">''</span>) {
                <span class="keyword">return</span>;
            }

            <span class="keyword">if</span> (isCommand(data.text)) {

                <span class="keyword">var</span> command = getCommandFrom(data.text);
                evaluate(command.name, command.args);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>maybe add here a socket.emit(&#39;execute command&#39;)
where the evaluate() returns true.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="keyword">else</span> {
                socket.emit(<span class="string">'send message'</span>, data);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>clear input tag</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            field.value = <span class="string">""</span>;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>generates the HTML element representing a message, and prints it.
data is the message object to print.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        printMessage = <span class="keyword">function</span>(data) {

            <span class="keyword">if</span> (!data.text) {
                <span class="keyword">return</span>;
            }

            <span class="keyword">var</span> messageHTMLElement = document.createElement(<span class="string">'div'</span>);
            messageHTMLElement.setAttribute(<span class="string">'class'</span>, <span class="string">'message clearfix'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>create the wrappers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> nicknameWrapperHTMLElement = document.createElement(<span class="string">'div'</span>),
                textWrapperHTMLElement     = document.createElement(<span class="string">'div'</span>),
                timeWrapperHTMLElement     = document.createElement(<span class="string">'div'</span>);

            nicknameWrapperHTMLElement.setAttribute(<span class="string">'class'</span>, <span class="string">'name'</span>);
            textWrapperHTMLElement    .setAttribute(<span class="string">'class'</span>, <span class="string">'text'</span>);
            timeWrapperHTMLElement    .setAttribute(<span class="string">'class'</span>, <span class="string">'time'</span>);

            <span class="keyword">var</span> nicknameHTMLElement = document.createElement(<span class="string">'b'</span>),
                idHTMLElement       = document.createElement(<span class="string">'span'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p> textHTMLElement     = document.createElement(&#39;span&#39;),</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                timeHTMLElement     = document.createElement(<span class="string">'time'</span>);

            nicknameHTMLElement.innerHTML = data.name;
            idHTMLElement.innerHTML = data.id;
            textWrapperHTMLElement.innerHTML = data.text;
            timeHTMLElement.innerHTML = (<span class="keyword">new</span> Date(data.time)).toLocaleTimeString();</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>append elements to the wrappers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            nicknameWrapperHTMLElement.appendChild(nicknameHTMLElement);
            nicknameWrapperHTMLElement.appendChild(idHTMLElement);</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>textWrapperHTMLElement.appendChild(textHTMLElement);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            timeWrapperHTMLElement.appendChild(timeHTMLElement);</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>append wrappers to the .message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            messageHTMLElement.appendChild(nicknameWrapperHTMLElement);
            messageHTMLElement.appendChild(textWrapperHTMLElement);
            messageHTMLElement.appendChild(timeWrapperHTMLElement);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>append the .message to content</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            content.appendChild(messageHTMLElement);
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>displays a notice like: <em>john is writing...</em>
the argument is an array of the users that 
are currently writing something.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        printNotice = <span class="keyword">function</span>(users) {

            <span class="keyword">if</span> (users.length &lt; <span class="number">1</span>) {
                notice.innerHTML = <span class="string">''</span>;
                <span class="keyword">return</span>;
            }

            <span class="keyword">var</span> str = users.join(<span class="string">', '</span>);
            
            <span class="keyword">if</span> (users.length &gt; <span class="number">1</span>) {
                str += <span class="string">' are '</span>;
            } <span class="keyword">else</span> {
                str += <span class="string">' is '</span>;
            }
            str += <span class="string">'writing...'</span>;

            notice.innerHTML = str;
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Scroll to the bottom.
scrollHeight is always higher than scrollTop, so it
will certainly bring us to the bottom.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        scrollToBottom = <span class="keyword">function</span>() {
            <span class="keyword">var</span> content = document.querySelector(<span class="string">'.content'</span>);
            content.scrollTop = content.scrollHeight;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Scroll to the bottom if user is in the viewport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        maybeScrollToBottom = <span class="keyword">function</span>() {
            <span class="keyword">var</span> content = document.querySelector(<span class="string">'.content'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>the maximum value scrollTop can assume.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            content.maxScrollTop = content.scrollHeight - content.offsetHeight;
            <span class="keyword">if</span> (content.maxScrollTop - content.scrollTop &lt;= content.offsetHeight) scrollToBottom();
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Checks if Notification is available in the browser. Then, asks to
the user the permission to send notifications, if it doesn&#39;t have it
already. Finally it sends a notification.
If you don&#39;t provide the data parameter, it will just enable notifications.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        sendNotification = <span class="keyword">function</span>(data) {
            <span class="keyword">if</span> (<span class="keyword">typeof</span> Notification === <span class="string">"function"</span>) {
                <span class="keyword">if</span> (!Notification.permission || Notification.permission === <span class="string">"default"</span>) {
                    Notification.requestPermission(<span class="keyword">function</span>(perm){</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>for Chrome and Safari
(because they haven&#39;t implemented Notification.permission yet)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (Notification.permission !== perm) {
                            Notification.permission = perm;
                        }
                    });
                }
                <span class="keyword">if</span> (Notification.permission === <span class="string">"granted"</span> &amp;&amp; data.text) {
                    <span class="keyword">var</span> notification = <span class="keyword">new</span> Notification(data.name, {
                       body: data.text,
                       tag: data.name
                    });
                }
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Removes an element from writingUsers.
value is the string to remove from the array.
Returns an array with the removed element; false otherwise.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        writingUsers.remove = <span class="keyword">function</span>(value) {
            <span class="keyword">var</span> idx = <span class="keyword">this</span>.indexOf(value);
            <span class="keyword">if</span> (idx != -<span class="number">1</span>) {
                <span class="keyword">return</span> <span class="keyword">this</span>.splice(idx, <span class="number">1</span>);
            }
            <span class="keyword">return</span> <span class="literal">false</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h3>Web Socket events</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.on(<span class="string">'connected'</span>, <span class="keyword">function</span>(data) {</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>First of all, let&#39;s recognize the user.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> user = {
            id: data.id
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>store Socket ID in client, for later use</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setId(data.id);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>returning user?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (getNick()) {

            user.name = getNick();
            user.isNewish = <span class="literal">false</span>;

        } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>set nickname for the first time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            user.name = generateNick();
            user.isNewish = <span class="literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>and save it client-side</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            setNick(user.name);

        }
        socket.emit(<span class="string">'recognizing user'</span>, user);
    });

    socket.on(<span class="string">'user recognized'</span>, <span class="keyword">function</span>(user) {

        <span class="keyword">var</span> welcomeMessage = {
            name: <span class="string">'Server'</span>,
            text: user.name + <span class="string">' has joined the chat. '</span>,
            type: <span class="number">0</span>,
            time: (<span class="keyword">new</span> Date()).getTime()
        };

        welcomeMessage.text += user.isNewish ? <span class="string">'Welcome!'</span> : <span class="string">'Welcome back!'</span>;
        printMessage(welcomeMessage);
        maybeScrollToBottom();

    });</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>this is a broadcast</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.on(<span class="string">'nickname set'</span>, <span class="keyword">function</span>(user) {

        printMessage({
            name: <span class="string">'Server'</span>,
            text: user.oldName + <span class="string">' changed his name to '</span> + user.newName,
            type: <span class="number">0</span>,
            time: (<span class="keyword">new</span> Date()).getTime(),
        });
        maybeScrollToBottom();
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>this is a broadcast too</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.on(<span class="string">'disconnected'</span>, <span class="keyword">function</span>(data) {

        printMessage({
            name: <span class="string">'Server'</span>,
            text: data.name + <span class="string">' disconnected.'</span>,
            type: <span class="number">0</span>,
            time: (<span class="keyword">new</span> Date()).getTime()
        });
        maybeScrollToBottom();
    });

    socket.on(<span class="string">'message'</span>, <span class="keyword">function</span>(data) {
        searchAndReplaceEmoticonsIn(data);
        printMessage(data);
        maybeScrollToBottom();
        sendNotification(data);
    });

    socket.on(<span class="string">'written'</span>, <span class="keyword">function</span>(data) {</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>if we don&#39;t have a timer for the user,
we instantiate one on the fly.
otherwise, we reset it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (timers[data.name]) {
            timers[data.name].reset();
        } <span class="keyword">else</span> {
            timers[data.name] = <span class="keyword">new</span> Timer(<span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>removes an user because the time has expired</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                writingUsers.remove(data.name);</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>redisplays the notice</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                printNotice(writingUsers);</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>maybe destroy the timer?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                timers[data.name] = <span class="number">0</span>;
            });

            timers[data.name].start();
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>remove the user if it&#39;s in writingUsers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (data.text == <span class="string">''</span> || data.text.substring(<span class="number">0</span>,<span class="number">1</span>) == <span class="string">'/'</span>) {
            writingUsers.remove(data.name);
        } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>add the user to writingUsers array, if it isn&#39;t in already</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (writingUsers.indexOf(data.name) == -<span class="number">1</span>) {
                writingUsers.push(data.name);
            }
        }

        printNotice(writingUsers);
    });

    socket.on(<span class="string">'messages loaded'</span>, <span class="keyword">function</span>(data) {
        <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;data.length; i++) {
            printMessage(data[i]);
        }
        scrollToBottom();
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <h3>Event listeners</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sendButton.addEventListener(<span class="string">'click'</span>, <span class="keyword">function</span>() {
        send(message());</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>alerts the server that this user is writing a message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        socket.emit(<span class="string">'writing'</span>, message());</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>enable Notifications (for WebKit users only)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        sendNotification();
    }, <span class="literal">false</span>);

    field.addEventListener(<span class="string">'keyup'</span>, <span class="keyword">function</span>(event) {</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>user pressed enter? then it&#39;s a message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (event.keyCode == <span class="number">13</span>) {
            send(message());
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>alerts the server that this user is writing a message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        socket.emit(<span class="string">'writing'</span>, message());

    }, <span class="literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p><em>&quot;The last 29 days of the month are the hardest.&quot; - Nikola Tesla</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
